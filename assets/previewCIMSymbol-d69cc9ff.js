import{u as F,e as E}from"./screenUtils-7afeb41c.js";import{s as Z,l as K,h as X,W as $,j as tt,p as et,O as it}from"./cimAnalyzer-fade93fe.js";import{l as rt}from"./Color-9f46ece8.js";import{U as ot}from"./request-7c0a9d4c.js";import{c as A}from"./typedArrayUtil-96f93e5b.js";import{f as at}from"./promiseUtils-ac1bd36f.js";import{o as mt}from"./CIMResourceManager-f2dc3d5c.js";import{c as nt}from"./Rasterizer-c0c27c81.js";import{O as Q,c as st,t as _,r as J}from"./utils-1aab1134.js";import{m as pt}from"./utils-e0744d8b.js";import{s as ct}from"./symbols-946d4e11.js";import{t as H,l as ht}from"./index-738baf21.js";import"./fontUtils-95b845d3.js";import"./Error-d97df89f.js";import"./string-feb899cf.js";import"./fieldUtils-66be74eb.js";import"./preload-helper-f8378b50.js";import"./geometry-d89d4a34.js";import"./ensureType-348c3d61.js";import"./Extent-fd3ac910.js";import"./JSONSupport-ed372989.js";import"./nextTick-3ee5a785.js";import"./cast-73cfc253.js";import"./Polyline-9d44200b.js";import"./typeUtils-2ccaf90d.js";import"./BidiEngine-836b7ef6.js";import"./aaBoundingRect-a7e9efee.js";import"./mathUtils-b3bee9e7.js";import"./jsonUtils-dd0891e0.js";import"./GeometryUtils-53652037.js";import"./enums-4b2a86a0.js";import"./alignmentUtils-ae955d28.js";import"./definitions-19bfb61c.js";import"./mat2d-94b8f776.js";import"./vec2-9030ffc5.js";import"./vec2f32-eaf29605.js";import"./number-b10bd8f5.js";import"./Rect-ea14f53a.js";import"./quantizationUtils-fd85d1bd.js";import"./floatRGBA-bff1e6d8.js";import"./colorUtils-639f4d25.js";import"./imageutils-92e8b989.js";import"./_commonjsHelpers-2f3e7994.js";import"./rasterizingUtils-9666244d.js";import"./asyncUtils-f0fdc8c7.js";import"./BlendLayer-5cec7349.js";import"./parser-a11e786f.js";import"./mat4f32-60a2394b.js";import"./mat4-1ee69bd5.js";import"./assets-2c955bed.js";import"./ItemCache-d06df2a7.js";import"./MemCache-7d4aa654.js";import"./CIMSymbol-0fa077f5.js";import"./enumeration-49e09bda.js";import"./opacityUtils-cc413a8c.js";import"./symbolLayerUtils3D-0c6ed99a.js";import"./aaBoundingBox-1eda6d1b.js";import"./persistableUrlUtils-26091271.js";import"./Collection-d9d92883.js";import"./Evented-e2ee9722.js";import"./SimpleObservable-04055e8d.js";import"./collectionUtils-e98ed3f0.js";import"./Portal-172924b2.js";import"./Loadable-c96deb83.js";import"./Promise-34cff6d6.js";import"./locale-30120714.js";import"./PortalGroup-751b527f.js";import"./PortalUser-7f979a04.js";import"./Clonable-5318ec31.js";import"./Basemap-1b908f31.js";import"./deprecate-424c57c7.js";import"./loadAll-f0d5998c.js";import"./PortalItem-a25335a3.js";import"./messages-226fbb40.js";import"./writeUtils-5c3c75bd.js";import"./layerUtils-a0871894.js";import"./compilerUtils-8d4f8499.js";import"./CollectionFlattener-52a0c7e4.js";import"./TablesMixin-1e04401c.js";import"./Layer-07a07202.js";import"./Identifiable-876da2a8.js";import"./Graphic-f117754c.js";import"./PopupTemplate-63dce4d3.js";import"./number-205e28e0.js";import"./Cyclical-0205ad3e.js";import"./reactiveUtils-307e98f9.js";import"./workers-4f8dfa2f.js";import"./Connection-5e453cc1.js";import"./Queue-c92bc561.js";import"./intl-7c488bb0.js";import"./projection-d7a5b449.js";import"./zscale-e06cee6f.js";import"./TileInfo-e107254e.js";import"./widget-945f9e61.js";import"./uuid-73213768.js";import"./HandleOwner-4c8d824c.js";import"./byteSizeEstimations-90c5a50d.js";import"./AttachmentInfo-9750c730.js";import"./AttachmentQuery-c89a8ac2.js";import"./LegendOptions-8200d5f5.js";import"./jsonUtils-37cc07d7.js";import"./UniqueValueRenderer-b6a7d586.js";import"./diffUtils-ac6d6369.js";import"./colorRamps-fff34da2.js";import"./sizeVariableUtils-d4870b0d.js";import"./visualVariableUtils-6f05f98d.js";import"./lengthUtils-bc8879ed.js";import"./jsonUtils-7442f08f.js";import"./styleUtils-1d3bc535.js";import"./DictionaryLoader-0dadb1e0.js";import"./LRUCache-9c365b2a.js";import"./heatmapUtils-16ee21b5.js";import"./vec4f64-aa64c7e9.js";import"./DataLayerSource-71059dc4.js";import"./Field-b17a677d.js";import"./fieldType-b21f2e7f.js";import"./executeForIds-0c62bbcf.js";import"./utils-ada6b2ec.js";import"./query-eac603fe.js";import"./normalizeUtils-9dc1c489.js";import"./normalizeUtilsCommon-155f1aa2.js";import"./urlUtils-6a004888.js";import"./pbfQueryUtils-bad736cf.js";import"./pbf-3634de4f.js";import"./OptimizedFeature-7af17710.js";import"./OptimizedFeatureSet-1d1ac4b9.js";import"./queryZScale-a0b71b11.js";import"./FeatureSet-00b7d51e.js";import"./Query-bf719160.js";import"./TimeExtent-d2d7594c.js";import"./featureConversionUtils-00c47b2e.js";import"./RelationshipQuery-a13e27d1.js";import"./TopFeaturesQuery-5bb7c994.js";import"./FeatureLayer-42e1678e.js";import"./MultiOriginJSONSupport-97bf66dd.js";import"./serviceCapabilitiesUtils-02cebe9b.js";import"./arcgisLayerUrl-9d6ab56c.js";import"./FeatureLayerBase-de1a166f.js";import"./HeightModelInfo-bad6650e.js";import"./OperationalLayer-a420b681.js";import"./ElevationInfo-75e7bf35.js";import"./TimeReference-b6332926.js";import"./datetime-b6333958.js";import"./editsZScale-b954eebc.js";import"./APIKeyMixin-b93c2049.js";import"./ArcGISService-cca20289.js";import"./CustomParametersMixin-01a04769.js";import"./EditBusLayer-984da402.js";import"./FeatureReductionLayer-fd41123b.js";import"./labelingInfo-f7d1c159.js";import"./labelUtils-6965a8ca.js";import"./defaultsJSON-b087dd4d.js";import"./OrderedLayer-9cb8835d.js";import"./PortalLayer-d54f6a39.js";import"./portalItemUtils-72345980.js";import"./RefreshableLayer-672ecb56.js";import"./ScaleRangeLayer-24099455.js";import"./TemporalLayer-c479c738.js";import"./FeatureTemplate-1fd8fac4.js";import"./FeatureType-b736019f.js";import"./fieldProperties-1fb52610.js";import"./FieldsIndex-7c963fe9.js";import"./versionUtils-aabb6832.js";import"./styleUtils-f45b991d.js";import"./popupUtils-3d5141e6.js";import"./colorUtils-c0f43caf.js";import"./webStyleSymbolUtils-54e19231.js";import"./devEnvironmentUtils-5002a058.js";import"./Scheduler-72fecd6f.js";import"./GraphicsCollection-89010fd9.js";import"./ViewingMode-915d19cb.js";import"./unitBezier-881ac1eb.js";import"./vec2f64-22afc56f.js";import"./mat3-d3027213.js";import"./mat3f32-6c416b1c.js";import"./TileStrategy-0607ccca.js";import"./TileStore-56391591.js";import"./TileKey-555f347f.js";import"./rbush-f2a85c98.js";import"./quickselect-56c5966e.js";import"./capabilities-d3148205.js";import"./context-util-09fcc133.js";import"./Util-a12911ae.js";import"./EffectView-7a98f2c6.js";import"./MapImageLayer-030c7912.js";import"./scaleUtils-2aca77b2.js";import"./SublayersOwner-3d3675ca.js";import"./Version-bbcb090a.js";import"./QueryTask-809f5bb4.js";import"./imageBitmapUtils-ce029f55.js";import"./pixelRangeUtils-03719dd8.js";import"./commonProperties-da958896.js";var Y;(function(u){u.Legend="legend",u.Preview="preview"})(Y||(Y={}));const T=u=>u&&u.scaleFactor?u.scaleFactor:1,lt=96/72;class gt{constructor(t,e){this._spatialReference=t,this._avoidSDF=e,this._resourceCache=new Map,this._imageDataCanvas=null,this._pictureMarkerCache=new Map,this._textRasterizer=new Z,this._cimResourceManager=new mt,this._rasterizer=new nt(this._cimResourceManager)}get resourceManager(){return this._cimResourceManager}async rasterizeCIMSymbolAsync(t,e,m,r,i,o,p,a){if(!t)return null;const{data:s}=t;if(!s||s.type!=="CIMSymbolReference"||!s.symbol)return null;const{symbol:C}=s;o||(o=Q(C));const M=await K.resolveSymbolOverrides(s,e,this._spatialReference,i,o,p,a);this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const l=this._imageDataCanvas,h=this._cimResourceManager,f=[];X.fetchResources(M,h,f),f.length>0&&await Promise.all(f);const{width:c,height:g}=m,d=ut(o,c,g,r),n=X.getEnvelope(M,d,h);if(!n)return null;const b=(window.devicePixelRatio||1)*lt;let y=1,P=0,w=0;switch(C.type){case"CIMPointSymbol":case"CIMTextSymbol":{let R=1;n.width>c&&(R=c/n.width);let k=1;n.height>g&&(k=g/n.height),r==="preview"&&(n.width<c&&(R=c/n.width),n.height<g&&(k=g/n.height)),y=Math.min(R,k),P=n.x+n.width/2,w=n.y+n.height/2}break;case"CIMLineSymbol":{let R=1;n.height>g&&(R=g/n.height),y=R,w=n.y+n.height/2;const k=n.x*y+c/2,z=(n.x+n.width)*y+c/2;if(k<0){const{paths:x}=d;x[0][0][0]-=k}if(z>c){const{paths:x}=d;x[0][2][0]-=z-c}}break;case"CIMPolygonSymbol":{P=n.x+n.width/2,w=n.y+n.height/2;const R=n.x*y+c/2,k=(n.x+n.width)*y+c/2,z=n.y*y+g/2,x=(n.y+n.height)*y+g/2,{rings:S}=d;R<0&&(S[0][0][0]-=R,S[0][3][0]-=R,S[0][4][0]-=R),z<0&&(S[0][0][1]+=z,S[0][1][1]+=z,S[0][4][1]+=z),k>c&&(S[0][1][0]-=k-c,S[0][2][0]-=k-c),x>g&&(S[0][2][1]+=x-g,S[0][3][1]+=x-g)}}l.width=c*b,l.height=g*b;const v=1;l.width+=2*v,l.height+=2*v;const I=l.getContext("2d"),D=it.createIdentity();return D.translate(-P,-w),D.scale(y*b,-y*b),D.translate(c*b/2+v,g*b/2+v),I.clearRect(0,0,l.width,l.height),new $(I,h,D,!0).drawSymbol(M,d),I.getImageData(0,0,l.width,l.height)}async analyzeCIMSymbol(t,e,m,r,i){const o=[],p=e?{geometryType:r,spatialReference:this._spatialReference,fields:e}:null;let a;await tt(t.data,p,this._cimResourceManager,o,this._avoidSDF),at(i);for(const s of o)s.cim.type!=="CIMPictureMarker"&&s.cim.type!=="CIMPictureFill"&&s.cim.type!=="CIMPictureStroke"||(a||(a=[]),a.push(this._fetchPictureMarkerResource(s,i))),m&&s.type==="text"&&typeof s.text=="string"&&s.text.includes("[")&&(s.text=st(m,s.text,s.cim.textCase));return a&&await Promise.all(a),o}rasterizeCIMSymbol3D(t,e,m,r,i,o){const p=[];for(const a of t){r&&typeof r.scaleFactor=="function"&&(r.scaleFactor=r.scaleFactor(e,i,o));const s=this._getRasterizedResource(a,e,m,r,i,o);if(!s)continue;let C=0,M=s.anchorX||0,l=s.anchorY||0,h=!1,f=0,c=0;if(m==="esriGeometryPoint"){const g=T(r);if(f=_(a.offsetX,e,i,o)*g||0,c=_(a.offsetY,e,i,o)*g||0,a.type==="marker")C=_(a.rotation,e,i,o)||0,h=!!a.rotateClockwise&&a.rotateClockwise;else if(a.type==="text"){if(C=_(a.angle,e,i,o)||0,a.horizontalAlignment!==void 0)switch(a.horizontalAlignment){case"left":M=-.5;break;case"right":M=.5;break;default:M=0}if(a.verticalAlignment!==void 0)switch(a.verticalAlignment){case"top":l=.5;break;case"bottom":l=-.5;break;case"baseline":l=-.25;break;default:l=0}}}s!=null&&p.push({angle:C,rotateClockWise:h,anchorX:M,anchorY:l,offsetX:f,offsetY:c,rasterizedResource:s})}return this.getSymbolImage(p)}getSymbolImage(t){const e=document.createElement("canvas"),m=A(e.getContext("2d"));let r=0,i=0,o=0,p=0;const a=[];for(let l=0;l<t.length;l++){const h=t[l],f=h.rasterizedResource;if(!f)continue;const c=f.size,g=h.offsetX,d=h.offsetY,n=h.anchorX,b=h.anchorY,y=h.rotateClockWise||!1;let P=h.angle,w=F(g)-c[0]*(.5+n),v=F(d)-c[1]*(.5+b),I=w+c[0],D=v+c[1];if(P){y&&(P=-P);const z=Math.sin(P*Math.PI/180),x=Math.cos(P*Math.PI/180),S=w*x-v*z,j=w*z+v*x,U=w*x-D*z,W=w*z+D*x,L=I*x-D*z,N=I*z+D*x,V=I*x-v*z,q=I*z+v*x;w=Math.min(S,U,L,V),v=Math.min(j,W,N,q),I=Math.max(S,U,L,V),D=Math.max(j,W,N,q)}r=w<r?w:r,i=v<i?v:i,o=I>o?I:o,p=D>p?D:p;const R=m.createImageData(f.size[0],f.size[1]);R.data.set(new Uint8ClampedArray(f.image.buffer));const k={offsetX:g,offsetY:d,rotateClockwise:y,angle:P,rasterizedImage:R,anchorX:n,anchorY:b};a.push(k)}e.width=o-r,e.height=p-i;const s=-r,C=p;for(let l=0;l<a.length;l++){const h=a[l],f=this._imageDataToCanvas(h.rasterizedImage),c=h.rasterizedImage.width,g=h.rasterizedImage.height,d=s-c*(.5+h.anchorX),n=C-g*(.5-h.anchorY);if(h.angle){const b=(360-h.angle)*Math.PI/180;m.save(),m.translate(F(h.offsetX),-F(h.offsetY)),m.translate(s,C),m.rotate(b),m.translate(-s,-C),m.drawImage(f,d,n),m.restore()}else m.drawImage(f,d+F(h.offsetX),n-F(h.offsetY))}const M=new ct({x:s/e.width-.5,y:C/e.height-.5});return{imageData:e.width!==0&&e.height!==0?m.getImageData(0,0,e.width,e.height):m.createImageData(1,1),anchorPosition:M}}async _fetchPictureMarkerResource(t,e){const m=t.materialHash;if(!this._pictureMarkerCache.get(m)){const r=(await ot(t.cim.url,{responseType:"image",signal:e&&e.signal})).data;this._pictureMarkerCache.set(m,r)}}_imageDataToCanvas(t){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const e=this._imageDataCanvas,m=A(e.getContext("2d"));return e.width=t.width,e.height=t.height,m.putImageData(t,0,0),e}_imageTo32Array(t,e,m,r){this._imageDataCanvas||(this._imageDataCanvas=document.createElement("canvas"));const i=this._imageDataCanvas,o=A(i.getContext("2d"));if(i.width=e,i.height=m,o.drawImage(t,0,0,e,m),r){o.save();const p=new rt(r);o.fillStyle=p.toHex(),o.globalCompositeOperation="multiply",o.fillRect(0,0,e,m),o.globalCompositeOperation="destination-atop",o.drawImage(t,0,0,e,m),o.restore()}return new Uint32Array(o.getImageData(0,0,e,m).data.buffer)}_getRasterizedResource(t,e,m,r,i,o){let p,a,s;if(t.type==="text")return this._rasterizeTextResource(t,e,r,i,o);({analyzedCIM:p,hash:a}=ft(t,e,i,o));const l=T(r);if(t.cim.type==="CIMPictureMarker"){const c=_(t.size,e,i,o)*l,{image:g,width:d,height:n}=A(this._getPictureResource(t,c,_(t.color,e,i,o)));return s={image:g,size:[d,n],sdf:!1,simplePattern:!1,anchorX:t.anchorPoint?t.anchorPoint.x:0,anchorY:t.anchorPoint?t.anchorPoint.y:0},s}pt(p,l,{preserveOutlineWidth:!1});const h=p;a+=m,r&&(a+=JSON.stringify(r));const f=this._resourceCache;return f.has(a)?f.get(a):(s=this._rasterizer.rasterizeJSONResource({cim:h,type:t.type,url:t.url,mosaicHash:a,size:null,path:null},window.devicePixelRatio||1,this._avoidSDF),f.set(a,s),s)}_rasterizeTextResource(t,e,m,r,i){const o=T(m),p=_(t.text,e,r,i);if(!p||p.length===0)return null;const a=_(t.fontName,e,r,i),s=_(t.style,e,r,i),C=_(t.weight,e,r,i),M=_(t.decoration,e,r,i),l=_(t.size,e,r,i)*o,h=_(t.horizontalAlignment,e,r,i),f=_(t.verticalAlignment,e,r,i),c=J(_(t.color,e,r,i)),g=J(_(t.outlineColor,e,r,i)),d={color:c,size:l,horizontalAlignment:h,verticalAlignment:f,font:{family:a,style:s,weight:C,decoration:M},halo:{size:_(t.outlineSize,e,r,i)||0,color:g,style:s},pixelRatio:1,premultiplyColors:!this._avoidSDF};return this._textRasterizer.rasterizeText(p,d)}_getPictureResource(t,e,m){const r=this._pictureMarkerCache.get(t.materialHash);if(!r)return null;const i=r.height/r.width,o=e?i>1?F(e):F(e)/i:r.width,p=e?i>1?F(e)*i:F(e):r.height;return{image:this._imageTo32Array(r,o,p,m),width:o,height:p}}}function ut(u,t,e,m){const i=-t/2+1,o=t/2-1,p=e/2-1,a=-e/2+1;switch(u){case"esriGeometryPoint":return{x:0,y:0};case"esriGeometryPolyline":return{paths:[[[i,0],[0,0],[o,0]]]};default:return m==="legend"?{rings:[[[i,p],[o,0],[o,a],[i,a],[i,p]]]}:{rings:[[[i,p],[o,p],[o,a],[i,a],[i,p]]]}}}function ft(u,t,e,m){let r,i;return typeof u.materialHash=="function"?(r=(0,u.materialHash)(t,e,m),i=et(u.cim,u.materialOverrides)):(r=u.materialHash,i=u.cim),{analyzedCIM:i,hash:r}}const G=new gt(null,!0),O=E(H.size),B=E(H.maxSize),dt=E(H.lineWidth),yt=1;function wt(u){const t=u==null?void 0:u.size;return typeof t=="number"?{width:t,height:t}:{width:t!=null&&typeof t=="object"&&"width"in t?t.width:null,height:t!=null&&typeof t=="object"&&"height"in t?t.height:null}}async function Br(u,t={}){var b;const{node:e,opacity:m,symbolConfig:r}=t,i=typeof r=="object"&&"isSquareFill"in r&&r.isSquareFill,o=t.cimOptions||t,p=o.geometryType||Q((b=u==null?void 0:u.data)==null?void 0:b.symbol),a=wt(t),{feature:s,fieldMap:C}=o;if(a.width==null||a.height==null){const y=await K.resolveSymbolOverrides(u.data,s,null,C,p);if(!y)return null;(u=u.clone()).data={type:"CIMSymbolReference",symbol:y},u.data.primitiveOverrides=void 0;const P=[];X.fetchResources(y,G.resourceManager,P),P.length>0&&await Promise.all(P);const w=X.getEnvelope(y,null,G.resourceManager),v=w==null?void 0:w.width,I=w==null?void 0:w.height;a.width=p==="esriGeometryPolygon"?O:p==="esriGeometryPolyline"?dt:v!=null&&isFinite(v)?Math.min(v,B):O,a.height=p==="esriGeometryPolygon"?O:I!=null&&isFinite(I)?Math.max(Math.min(I,B),yt):O}const M=await G.rasterizeCIMSymbolAsync(u,s,a,i||p!=="esriGeometryPolygon"?Y.Preview:Y.Legend,C,p);if(!M)return null;const{width:l,height:h}=M,f=document.createElement("canvas");f.width=l,f.height=h,f.getContext("2d").putImageData(M,0,0);const c=F(a.width),g=F(a.height),d=new Image(c,g);d.src=f.toDataURL(),m!=null&&(d.style.opacity=`${m}`);let n=d;if(t.effectView!=null){const y={shape:{type:"image",x:0,y:0,width:c,height:g,src:d.src},fill:null,stroke:null,offset:[0,0]};n=ht([[y]],[c,g],{effectView:t.effectView})}return e&&n&&e.appendChild(n),n}export{Br as previewCIMSymbol};
