import{e as o,y as h,a as p}from"./Accessor-815cb0cf.js";import{s as u}from"./Error-781981d1.js";import{x as c,g as d}from"./promiseUtils-28f2a985.js";import"./ensureType-125d327f.js";import"./typedArrayUtil-74bbfd45.js";import{j as g}from"./Collection-912f4315.js";import"./string-75082bc6.js";import{l as v}from"./watch-c7facfb0.js";const a=new g,n=new WeakMap;function y(e){l(e)&&a.push(e)}function I(e){l(e)&&a.includes(e)&&a.remove(e)}function l(e){return e!=null&&typeof e=="object"&&"refreshInterval"in e&&"refresh"in e}function m(e,r){return Number.isFinite(e)&&Number.isFinite(r)?r<=0?e:m(r,e%r):0}let f=0,i=0;function b(){const e=Date.now();for(const r of a)r.refreshInterval&&e-(n.get(r)??0)+5>=6e4*r.refreshInterval&&(n.set(r,e),r.refresh(e))}v(()=>{const e=Date.now();let r=0;for(const t of a)r=m(Math.round(6e4*t.refreshInterval),r),t.refreshInterval?n.get(t)||n.set(t,e):n.delete(t);if(r!==i){if(i=r,clearInterval(f),i===0)return void(f=0);f=setInterval(b,i)}});const N=e=>{let r=class extends e{constructor(...t){super(...t),this.refreshInterval=0,this.refreshTimestamp=0,this._debounceHasDataChanged=c(()=>this.hasDataChanged()),this.when().then(()=>{y(this)},()=>{})}destroy(){I(this)}get refreshParameters(){return{_ts:this.refreshTimestamp||null}}refresh(t=Date.now()){d(this._debounceHasDataChanged()).then(s=>{s&&this._set("refreshTimestamp",t),this.emit("refresh",{dataChanged:s})},s=>{u.getLogger(this.declaredClass).error(s),this.emit("refresh",{dataChanged:!1,error:s})})}async hasDataChanged(){return!0}};return o([h({type:Number,cast:t=>t>=.1?t:t<=0?0:.1,json:{write:!0}})],r.prototype,"refreshInterval",void 0),o([h({readOnly:!0})],r.prototype,"refreshTimestamp",void 0),o([h()],r.prototype,"refreshParameters",null),r=o([p("esri.layers.mixins.RefreshableLayer")],r),r};export{N as p};
