import{e as i,a as x,y as l,v as be}from"./Accessor-815cb0cf.js";import{j as ee}from"./Collection-912f4315.js";import{s as B,a as q}from"./Error-781981d1.js";import{t as c,r as j,g as F}from"./typedArrayUtil-74bbfd45.js";import{O as Ee}from"./MultiOriginJSONSupport-6a5e69d5.js";import{s as Le}from"./cast-f7d2a22f.js";import{a as d,f as ge,o as Y,r as se,w as ie,E as je,J as Se}from"./Extent-8fae2379.js";import{b as Oe}from"./Layer-84815c0a.js";import{n as Ce}from"./BlendLayer-f72967b1.js";import{c as Te}from"./OperationalLayer-fb5eac0c.js";import{t as Ve}from"./ScaleRangeLayer-abd4cd2e.js";import{U as te,t as Pe,Z as ve,Y as Ue,u as He,V as Ae}from"./request-b4e08038.js";import{n as We}from"./uuid-73213768.js";import"./ensureType-125d327f.js";import{i as Ne}from"./Identifiable-f5397426.js";import{u as xe}from"./JSONSupport-2b897629.js";import{m as we}from"./Loadable-6776e4d9.js";import{h as S,j as Ge,u as Be}from"./perspectiveUtils-7d4aec38.js";import{c as z}from"./screenUtils-7afeb41c.js";import{u as Fe}from"./mat3-53e5916e.js";import{t as ze,e as oe}from"./mat3f64-221ce671.js";import{r as N,L as G,A as pe}from"./vec2-4c517306.js";import{n as M,r as D}from"./vec2f64-22afc56f.js";import{v as ae}from"./Polyline-40b9e769.js";import{u as re,_ as Je,r as ke}from"./projection-4083e235.js";import{l as qe}from"./Clonable-6d5134c7.js";import"./string-75082bc6.js";import{b as De,r as Ke}from"./mathUtils-15f63a45.js";import{t as Ye}from"./resourceExtension-33fb71ab.js";import{c as Qe,m as me,U as Xe,R as Ze}from"./persistableUrlUtils-5532b98d.js";import"./geometry-0d19f94b.js";import{n as et}from"./collectionUtils-5a99c1c0.js";import{n as tt}from"./Evented-3dfb26f2.js";import{a as ot}from"./HandleOwner-124247b4.js";import{m as rt}from"./Promise-092442f7.js";import{f as nt}from"./promiseUtils-28f2a985.js";import{l as st}from"./reactiveUtils-31da19f9.js";import{c as it}from"./aaBoundingRect-3cd21eb0.js";import{o as at}from"./BoundsStore-be53c75d.js";import"./watch-c7facfb0.js";import"./ArrayPool-ae2ef0ab.js";import"./nextTick-3ee5a785.js";import"./SimpleObservable-729c9019.js";import"./preload-helper-101896b7.js";import"./jsonUtils-0607c004.js";import"./parser-527c5e80.js";import"./colorUtils-639f4d25.js";import"./mat4f32-60a2394b.js";import"./mat4-a8da3f27.js";import"./commonProperties-6a723db4.js";import"./TimeExtent-202e4138.js";import"./ElevationInfo-5862799c.js";import"./fieldUtils-39eb4f5d.js";import"./lengthUtils-40356f92.js";import"./opacityUtils-107b33de.js";import"./normalizeUtilsSync-f6be8e80.js";import"./jsonUtils-15ca15d7.js";import"./normalizeUtilsCommon-04cad10b.js";import"./assets-fff829c9.js";import"./zscale-a617710a.js";import"./typeUtils-3bf84b36.js";import"./PooledRBush-39319051.js";import"./quickselect-56c5966e.js";let ne=class extends qe{projectOrWarn(t,o){if(c(t))return t;const{geometry:r,pending:n}=re(t,o);return n?null:n||r?r:(B.getLogger(this.declaredClass).warn("geometry could not be projected to the spatial reference",{georeference:this,geometry:t,sourceSpatialReference:t.spatialReference,targetSpatialReference:o}),null)}};ne=i([x("esri.layers.support.GeoreferenceBase")],ne);const Q=ne,X=oe(),m=M();let J=class extends be{constructor(){super(...arguments),this.sourcePoint=null,this.mapPoint=null}};i([l()],J.prototype,"sourcePoint",void 0),i([l({type:d})],J.prototype,"mapPoint",void 0),J=i([x("esri.layers.support.ControlPoint")],J);let y=class extends xe(Q){constructor(t){super(t),this.controlPoints=null,this.height=0,this.type="control-points",this.width=0}readControlPoints(t,o){const r=ge.fromJSON(o.spatialReference),n=ze(...o.coefficients,1);return t.map(s=>(N(m,s.x,s.y),S(m,m,n),{sourcePoint:s,mapPoint:new d({x:m[0],y:m[1],spatialReference:r})}))}writeControlPoints(t,o,r,n){if(c(this.transform)){const s=new q("web-document-write:invalid-georeference","Invalid 'controlPoints', 'width', 'height' configuration.",{layer:n==null?void 0:n.layer,georeference:this});n!=null&&n.messages?n.messages.push(s):B.getLogger(this.declaredClass).error(s.name,s.message)}else j(t)&&h(t[0])&&(o.controlPoints=t.map(s=>{const a=F(s.sourcePoint);return{x:a.x,y:a.y}}),o.spatialReference=t[0].mapPoint.spatialReference.toJSON(),o.coefficients=this.transform.slice(0,8))}get coords(){if(c(this.controlPoints))return null;const t=this._updateTransform(X);if(c(t)||!h(this.controlPoints[0]))return null;const o=this.controlPoints[0].mapPoint.spatialReference;return ut(t,this.width,this.height,o)}set coords(t){if(c(this.controlPoints)||!h(this.controlPoints[0]))return;const o=this.controlPoints[0].mapPoint.spatialReference;if(t=this.projectOrWarn(t,o),c(t))return;const{width:r,height:n}=this,{rings:[[s,a,p,u]]}=t,g={sourcePoint:z(0,n),mapPoint:new d({x:s[0],y:s[1],spatialReference:o})},P={sourcePoint:z(0,0),mapPoint:new d({x:a[0],y:a[1],spatialReference:o})},v={sourcePoint:z(r,0),mapPoint:new d({x:p[0],y:p[1],spatialReference:o})},b={sourcePoint:z(r,n),mapPoint:new d({x:u[0],y:u[1],spatialReference:o})};h(g)&&h(P)&&h(v)&&h(b)&&(ue(X,g,P,v,b),this.controlPoints=F(this.controlPoints).map(({sourcePoint:T})=>(N(m,T.x,T.y),S(m,m,X),{sourcePoint:T,mapPoint:new d({x:m[0],y:m[1],spatialReference:o})})))}get inverseTransform(){return c(this.transform)?null:Fe(oe(),this.transform)}get transform(){return this._updateTransform()}toMap(t){if(c(t)||c(this.transform)||c(this.controlPoints)||!h(this.controlPoints[0]))return null;N(m,t.x,t.y);const o=this.controlPoints[0].mapPoint.spatialReference;return S(m,m,this.transform),new d({x:m[0],y:m[1],spatialReference:o})}toSource(t){if(c(t)||c(this.inverseTransform)||c(this.controlPoints)||!h(this.controlPoints[0]))return null;const o=this.controlPoints[0].mapPoint.spatialReference;return t=t.normalize(),t=re(t,o).geometry,c(t)?null:(N(m,t.x,t.y),S(m,m,this.inverseTransform),z(m[0],m[1]))}_updateTransform(t){const{controlPoints:o,width:r,height:n}=this;if(c(o)||!(r>0)||!(n>0))return null;const[s,a,p,u]=o;if(!h(s))return null;const g=s.mapPoint.spatialReference,P=this._projectControlPoint(a,g),v=this._projectControlPoint(p,g),b=this._projectControlPoint(u,g);if(!P.valid||!v.valid||!b.valid||!h(P.controlPoint))return null;c(t)&&(t=oe());let T=null;return T=h(v.controlPoint)&&h(b.controlPoint)?ue(t,s,P.controlPoint,v.controlPoint,b.controlPoint):h(v.controlPoint)?ct(t,s,P.controlPoint,v.controlPoint):lt(t,s,P.controlPoint),T.every(Me=>Me===0)?null:T}_projectControlPoint(t,o){if(!h(t))return{valid:!0,controlPoint:t};const{sourcePoint:r,mapPoint:n}=t,{geometry:s,pending:a}=re(n,o);return a?{valid:!1,controlPoint:null}:a||s?{valid:!0,controlPoint:{sourcePoint:r,mapPoint:s}}:(B.getLogger(this.declaredClass).warn("map point could not be projected to the spatial reference",{georeference:this,controlPoint:t,sourceSpatialReference:n.spatialReference,targetSpatialReference:o}),{valid:!1,controlPoint:null})}};function h(e){return j(e)&&j(e.sourcePoint)&&j(e.mapPoint)}i([l({type:[J],json:{write:{allowNull:!1,isRequired:!0}}})],y.prototype,"controlPoints",void 0),i([Y("controlPoints")],y.prototype,"readControlPoints",null),i([se("controlPoints")],y.prototype,"writeControlPoints",null),i([l()],y.prototype,"coords",null),i([l({json:{write:!0}})],y.prototype,"height",void 0),i([l({readOnly:!0})],y.prototype,"inverseTransform",null),i([l({readOnly:!0})],y.prototype,"transform",null),i([l({json:{write:!0}})],y.prototype,"width",void 0),y=i([x("esri.layers.support.ControlPointsGeoreference")],y);const w=M(),R=M(),V=M(),O=M(),_=M(),$=M(),U=M(),C=M(),K=Math.PI/2;function I(e,t,o){N(e,o.sourcePoint.x,o.sourcePoint.y),N(t,o.mapPoint.x,o.mapPoint.y)}function lt(e,t,o){return I(w,_,t),I(R,$,o),G(V,R,w,K),G(O,w,R,K),G(U,$,_,-K),G(C,_,$,-K),le(e,w,R,V,O,_,$,U,C)}function ct(e,t,o,r){return I(w,_,t),I(R,$,o),I(V,U,r),pe(O,w,R,.5),G(O,V,O,Math.PI),pe(C,_,$,.5),G(C,U,C,Math.PI),le(e,w,R,V,O,_,$,U,C)}function ue(e,t,o,r,n){return I(w,_,t),I(R,$,o),I(V,U,r),I(O,C,n),le(e,w,R,V,O,_,$,U,C)}const pt=new Array(8).fill(0),mt=new Array(8).fill(0);function de(e,t,o,r,n){return e[0]=t[0],e[1]=t[1],e[2]=o[0],e[3]=o[1],e[4]=r[0],e[5]=r[1],e[6]=n[0],e[7]=n[1],e}function le(e,t,o,r,n,s,a,p,u){return Ge(e,de(pt,t,o,r,n),de(mt,s,a,p,u))}function ut(e,t,o,r){const n=D(0,o),s=D(0,0),a=D(t,0),p=D(t,o);return S(n,n,e),S(s,s,e),S(a,a,e),S(p,p,e),new ae({rings:[[n,s,a,p,n]],spatialReference:r})}const Re=y;let E=class extends Q{constructor(t){super(t),this.bottomLeft=null,this.bottomRight=null,this.topLeft=null,this.topRight=null,this.type="corners"}get coords(){let{topLeft:t,topRight:o,bottomLeft:r,bottomRight:n}=this;if(c(t)||c(o)||c(r)||c(n))return null;const s=t.spatialReference;return o=this.projectOrWarn(o,s),r=this.projectOrWarn(r,s),n=this.projectOrWarn(n,s),c(o)||c(r)||c(n)?null:new ae({rings:[[[r.x,r.y],[t.x,t.y],[o.x,o.y],[n.x,n.y],[r.x,r.y]]],spatialReference:s})}set coords(t){const{topLeft:o}=this;if(c(o))return;const r=o.spatialReference;if(t=this.projectOrWarn(t,r),c(t))return;const{rings:[[n,s,a,p]]}=t;this.bottomLeft=new d({x:n[0],y:n[1],spatialReference:r}),this.topLeft=new d({x:s[0],y:s[1],spatialReference:r}),this.topRight=new d({x:a[0],y:a[1],spatialReference:r}),this.bottomRight=new d({x:p[0],y:p[1],spatialReference:r})}};i([l()],E.prototype,"coords",null),i([l({type:d})],E.prototype,"bottomLeft",void 0),i([l({type:d})],E.prototype,"bottomRight",void 0),i([l({type:d})],E.prototype,"topLeft",void 0),i([l({type:d})],E.prototype,"topRight",void 0),E=i([x("esri.layers.support.CornersGeoreference")],E);const dt=E;let H=class extends Q{constructor(e){super(e),this.extent=null,this.rotation=0,this.type="extent-and-rotation"}get coords(){if(c(this.extent))return null;const{xmin:e,ymin:t,xmax:o,ymax:r,spatialReference:n}=this.extent;let s;if(this.rotation){const{x:a,y:p}=this.extent.center,u=he(a,p,this.rotation);s=[u(e,t),u(e,r),u(o,r),u(o,t)],s.push(s[0])}else s=[[e,t],[e,r],[o,r],[o,t],[e,t]];return new ae({rings:[s],spatialReference:n})}set coords(e){if(c(e)||c(this.extent))return;const t=this.extent.spatialReference;if(e=this.projectOrWarn(e,t),c(e)||c(e.extent))return;const{rings:[[o,r,n]],extent:{center:{x:s,y:a}}}=e,p=De(Math.PI/2-Math.atan2(r[1]-o[1],r[0]-o[0])),u=he(s,a,-p),[g,P]=u(o[0],o[1]),[v,b]=u(n[0],n[1]);this.extent=new ie({xmin:g,ymin:P,xmax:v,ymax:b,spatialReference:t}),this.rotation=p}};function he(e,t,o){const r=Ke(o),n=Math.cos(r),s=Math.sin(r);return(a,p)=>[n*(a-e)+s*(p-t)+e,n*(p-t)-s*(a-e)+t]}i([l()],H.prototype,"coords",null),i([l({type:ie})],H.prototype,"extent",void 0),i([l({type:Number})],H.prototype,"rotation",void 0),H=i([x("esri.layers.support.ExtentAndRotationGeoreference")],H);const ht=H,ft={key:"type",base:Q,typeMap:{"control-points":Re,corners:dt,"extent-and-rotation":ht}};let A=class extends Ne(xe(we)){constructor(){super(...arguments),this.georeference=null,this.opacity=1}readGeoreference(e){return Re.fromJSON(e)}};i([l({types:ft,json:{write:!0}})],A.prototype,"georeference",void 0),i([Y("georeference")],A.prototype,"readGeoreference",null),i([l()],A.prototype,"opacity",void 0),A=i([x("esri.layers.support.MediaElementBase")],A);const ce=A;let L=class extends ce{constructor(e){super(e),this.content=null,this.image=null,this.type="image",this.image=null}load(){const e=this.image;if(typeof e=="string"){const t=te(e,{responseType:"image"}).then(({data:o})=>{this._set("content",o)});this.addResolvingPromise(t)}else if(e instanceof HTMLImageElement){const t=e.decode().then(()=>{this._set("content",e)});this.addResolvingPromise(t)}else e?this._set("content",e):this.addResolvingPromise(Promise.reject(new q("image-element:invalid-image-type","Invalid image type",{image:e})));return Promise.resolve(this)}readImage(e,t,o){return Qe(t.url,o)}writeImage(e,t,o,r){if(c(e))return;const n=r==null?void 0:r.portalItem,s=r==null?void 0:r.resources;if(!n||!s)return void(typeof e=="string"&&(t[o]=me(e,r)));const a=typeof e!="string"||Pe(e)||ve(e)?null:e;if(a){if(Xe(a)==null)return void(t[o]=a);const p=me(a,{...r,verifyItemRelativeUrls:r&&r.verifyItemRelativeUrls?{writtenUrls:r.verifyItemRelativeUrls.writtenUrls,rootPath:void 0}:void 0},Ze.NO);if(n&&p&&!Ue(p))return s.toKeep.push({resource:n.resourceFromPath(p),compress:!1}),void(t[o]=p)}t[o]="<pending>",s.pendingOperations.push($e(e).then(p=>{const u=gt(p,n);t[o]=u.itemRelativeUrl,s.toAdd.push({resource:u,content:p,compress:!1,finish:g=>{this.image=g.url}})}))}};i([l({readOnly:!0})],L.prototype,"content",void 0),i([l({json:{name:"url",type:String}})],L.prototype,"image",void 0),i([Y("image",["url"])],L.prototype,"readImage",null),i([se("image")],L.prototype,"writeImage",null),i([l({readOnly:!0,json:{name:"mediaType"}})],L.prototype,"type",void 0),L=i([x("esri.layers.support.ImageElement")],L);const _e=L;async function $e(e){if(typeof e=="string"){if(ve(e)){const{data:t}=await te(e,{responseType:"blob"});return t}return Pe(e)?He(e):$e((await te(e,{responseType:"image"})).data)}return new Promise(t=>yt(e).toBlob(t))}function yt(e){if(e instanceof HTMLCanvasElement)return e;const t=e instanceof HTMLImageElement?e.naturalWidth:e.width,o=e instanceof HTMLImageElement?e.naturalHeight:e.height,r=document.createElement("canvas"),n=r.getContext("2d");return r.width=t,r.height=o,e instanceof HTMLImageElement?n.drawImage(e,0,0,e.width,e.height):e instanceof ImageData&&n.putImageData(e,0,0),r}function gt(e,t){const o=We(),r=`${Ae("media",o)}.${Ye(e)}`;return t.resourceFromPath(r)}let k=class extends ce{constructor(e){super(e),this.content=null,this.type="video"}load(){const e=this.video;if(typeof e=="string"){const t=document.createElement("video");t.src=e,t.crossOrigin="anonymous",t.autoplay=!0,t.muted=!0,t.loop=!0,this.addResolvingPromise(this._loadVideo(t).then(()=>{this._set("content",t)}))}else e instanceof HTMLVideoElement?this.addResolvingPromise(this._loadVideo(e).then(()=>{this._set("content",e)})):this.addResolvingPromise(Promise.reject(new q("video-element:invalid-video-type","Invalid video type",{video:e})));return Promise.resolve(this)}set video(e){this.loadStatus==="not-loaded"?this._set("video",e):B.getLogger(this.declaredClass).error("#video","video cannot be changed after the element is loaded.")}_loadVideo(e){return new Promise((t,o)=>{e.oncanplay=()=>{e.oncanplay=null,e.play().then(t,o)},e.crossOrigin!=="anonymous"&&(e.crossOrigin="anonymous",e.src=e.src)})}};i([l({readOnly:!0})],k.prototype,"content",void 0),i([l()],k.prototype,"video",null),k=i([x("esri.layers.support.VideoElement")],k);const Ie=k,Pt={key:"type",defaultKeyValue:"image",base:ce,typeMap:{image:_e,video:Ie}},fe=ee.ofType(Pt);let W=class extends we.LoadableMixin(rt(ot(tt.EventedAccessor))){constructor(e){super(e),this._index=new at,this._elementViewsMap=new Map,this._elementsIndexes=new Map,this._elementsChangedHandler=t=>{for(const r of t.removed){const n=this._elementViewsMap.get(r);this._elementViewsMap.delete(r),this._index.delete(n),this.handles.remove(n),n.destroy(),this.notifyChange("fullExtent")}const{spatialReference:o}=this;for(const r of t.added){if(this._elementViewsMap.get(r))continue;const n=new Be({spatialReference:o,element:r});this._elementViewsMap.set(r,n);const s=st(()=>n.coords,()=>this._updateIndexForElement(n,!1));this._updateIndexForElement(n,!0),this.handles.add(s,n)}this._elementsIndexes.clear(),this.elements.forEach((r,n)=>this._elementsIndexes.set(r,n)),this.emit("refresh")},this.elements=new fe}async load(e){if(nt(e),!this.spatialReference){const t=this.elements.find(o=>j(o.georeference)&&j(o.georeference.coords));this._set("spatialReference",t?F(F(t.georeference).coords).spatialReference:ge.WGS84)}return this._elementsChangedHandler({added:this.elements.items,removed:[]}),this.handles.add(this.elements.on("change",this._elementsChangedHandler)),this}destroy(){this._index.clear(),this._elementViewsMap.clear(),this._elementsIndexes.clear()}set elements(e){this._set("elements",et(e,this._get("elements"),fe))}get fullExtent(){if(this.loadStatus==="not-loaded")return null;const e=this._index.fullBounds;return c(e)?null:new ie({xmin:e[0],ymin:e[1],xmax:e[2],ymax:e[3],spatialReference:this.spatialReference})}set spatialReference(e){this.loadStatus==="not-loaded"?this._set("spatialReference",e):B.getLogger(this.declaredClass).error("#spatialReference","spatialReference cannot be changed after the source is loaded.")}async queryElements(e,t){await this.load(),await Je(e.spatialReference,this.spatialReference,null,t);const o=je(e.spatialReference,this.spatialReference)?e:ke(e,this.spatialReference);if(!o)return[];const r=o.normalize(),n=[];for(const s of r)this._index.forEachInBounds(it(s),({normalizedCoords:a,element:p})=>{j(a)&&Se(s,a)&&n.push(p)});return n.sort((s,a)=>this._elementsIndexes.get(s)-this._elementsIndexes.get(a)),n}_updateIndexForElement(e,t){const o=e.normalizedBounds,r=this._index.has(e),n=j(o);this._index.delete(e),n&&this._index.set(e,o),this.notifyChange("fullExtent"),t||(r!==n?this.emit("refresh"):this.emit("change",{element:e.element}))}};i([l()],W.prototype,"elements",null),i([l({readOnly:!0})],W.prototype,"fullExtent",null),i([l()],W.prototype,"spatialReference",null),W=i([x("esri.layers.support.LocalMediaElementSource")],W);const Z=W;function ye(e){return typeof e=="object"&&e!=null&&"type"in e}let f=class extends Ce(Ve(Te(Ee(Oe)))){constructor(e){super(e),this.effectiveSource=null,this.copyright=null,this.operationalLayerType="MediaLayer",this.spatialReference=null,this.type="media",this.source=new Z}load(e){const t=this.source;if(!t)return this.addResolvingPromise(Promise.reject(new q("media-layer:source-missing","Set 'MediaLayer.source' before loading the layer."))),Promise.resolve(this);const o=ye(t)?new Z({elements:new ee([t])}):t;this._set("effectiveSource",o),this.spatialReference&&(o.spatialReference=this.spatialReference);const r=o.load(e).then(()=>{this.spatialReference=o.spatialReference});return this.addResolvingPromise(r),Promise.resolve(this)}destroy(){var e,t;(e=F(this.effectiveSource))==null||e.destroy(),(t=F(this.source))==null||t.destroy()}get fullExtent(){return this.loaded?this.effectiveSource.fullExtent:null}set source(e){this.loadStatus==="not-loaded"?this._set("source",e):B.getLogger(this.declaredClass).error("#source","source cannot be changed after the layer is loaded.")}castSource(e){return e?Array.isArray(e)||e instanceof ee?new Z({elements:e}):e:null}readSource(e,t,o){const r=t.mediaType==="image"?new _e:t.mediaType==="video"?new Ie:null;return r==null||r.read(t,o),r}writeSource(e,t,o,r){var n;e&&ye(e)&&e.type==="image"?e.write(t,r):r!=null&&r.messages&&((n=r==null?void 0:r.messages)==null||n.push(new q("media-layer:unsupported-source","source must be an 'ImageElement'")))}};i([l({readOnly:!0})],f.prototype,"effectiveSource",void 0),i([l({type:String})],f.prototype,"copyright",void 0),i([l({readOnly:!0})],f.prototype,"fullExtent",null),i([l({type:["MediaLayer"]})],f.prototype,"operationalLayerType",void 0),i([l({type:["show","hide"]})],f.prototype,"listMode",void 0),i([l({nonNullable:!0,json:{write:{enabled:!0,allowNull:!1}}})],f.prototype,"source",null),i([Le("source")],f.prototype,"castSource",null),i([Y("source",["url"])],f.prototype,"readSource",null),i([se("source")],f.prototype,"writeSource",null),i([l()],f.prototype,"spatialReference",void 0),i([l({readOnly:!0})],f.prototype,"type",void 0),f=i([x("esri.layers.MediaLayer")],f);const Oo=f;export{Oo as default};
