import{e as o,y as a,a as $,v as T,z as v,r as g}from"./JSONSupport-ed372989.js";import{U as b}from"./request-7c0a9d4c.js";import{T as P}from"./TimeExtent-d2d7594c.js";import{a as S}from"./Error-d97df89f.js";import{a as w}from"./HandleOwner-4c8d824c.js";import{l as N}from"./loadAll-f0d5998c.js";import{r as L}from"./typedArrayUtil-96f93e5b.js";import{O as D}from"./MultiOriginJSONSupport-97bf66dd.js";import{w as F,j as M}from"./promiseUtils-ac1bd36f.js";import{T as _}from"./ensureType-348c3d61.js";import{a as R,o as j,r as J}from"./Extent-fd3ac910.js";import{i as U}from"./scaleUtils-2aca77b2.js";import{b as V}from"./Layer-07a07202.js";import{i as q}from"./APIKeyMixin-b93c2049.js";import{i as k,E as A,y as z,n as x,Z as C}from"./SublayersOwner-3d3675ca.js";import{p as B}from"./ArcGISService-cca20289.js";import{n as G}from"./BlendLayer-5cec7349.js";import{o as H}from"./CustomParametersMixin-01a04769.js";import{b as K,c as W,f as Z}from"./OperationalLayer-a420b681.js";import{_ as Q}from"./PortalLayer-d54f6a39.js";import{p as X}from"./RefreshableLayer-672ecb56.js";import{t as Y}from"./ScaleRangeLayer-24099455.js";import{a as ee}from"./TemporalLayer-c479c738.js";import{t as re}from"./serviceCapabilitiesUtils-02cebe9b.js";import{e as te}from"./imageBitmapUtils-ce029f55.js";import{e as se}from"./versionUtils-aabb6832.js";import{a as I}from"./TimeReference-b6332926.js";function Me(e){var i;const r=e.layer;return"floorInfo"in r&&((i=r.floorInfo)!=null&&i.floorField)&&"floors"in e.view?E(e.view.floors,r.floorInfo.floorField):null}function O(e,r){var i;return"floorInfo"in r&&((i=r.floorInfo)!=null&&i.floorField)?E(e,r.floorInfo.floorField):null}function E(e,r){if(!(e!=null&&e.length))return null;const i=e.filter(t=>t!=="").map(t=>`'${t}'`);return i.push("''"),`${r} IN (${i.join(",")}) OR ${r} IS NULL`}const ie={visible:"visibleSublayers",definitionExpression:"layerDefs",labelingInfo:"hasDynamicLayers",labelsVisible:"hasDynamicLayers",opacity:"hasDynamicLayers",minScale:"visibleSublayers",maxScale:"visibleSublayers",renderer:"hasDynamicLayers",source:"hasDynamicLayers"};let m=class extends w(T){constructor(e){super(e),this.floors=null,this.scale=0}destroy(){this.layer=null}get dynamicLayers(){if(!this.hasDynamicLayers)return null;const e=this.visibleSublayers.map(r=>{const i=O(this.floors,r);return r.toExportImageJSON(i)});return e.length?JSON.stringify(e):null}get hasDynamicLayers(){return this.layer&&k(this.visibleSublayers,this.layer.serviceSublayers,this.layer.gdbVersion)}set layer(e){this._get("layer")!==e&&(this._set("layer",e),this.handles.remove("layer"),e&&this.handles.add([e.allSublayers.on("change",()=>this.notifyChange("visibleSublayers")),e.on("sublayer-update",r=>this.notifyChange(ie[r.propertyName]))],"layer"))}get layers(){const e=this.visibleSublayers;return e?e.length?"show:"+e.map(r=>r.id).join(","):"show:-1":null}get layerDefs(){var i;const e=!!((i=this.floors)!=null&&i.length),r=this.visibleSublayers.filter(t=>t.definitionExpression!=null||e&&t.floorInfo!=null);return r.length?JSON.stringify(r.reduce((t,s)=>{const n=O(this.floors,s),y=re(n,s.definitionExpression);return L(y)&&(t[s.id]=y),t},{})):null}get version(){this.commitProperty("layers"),this.commitProperty("layerDefs"),this.commitProperty("dynamicLayers"),this.commitProperty("timeExtent");const e=this.layer;return e&&(e.commitProperty("dpi"),e.commitProperty("imageFormat"),e.commitProperty("imageTransparency"),e.commitProperty("gdbVersion")),(this._get("version")||0)+1}get visibleSublayers(){const e=[];if(!this.layer)return e;const r=this.layer.sublayers,i=s=>{const n=this.scale,y=n===0,u=s.minScale===0||n<=s.minScale,c=s.maxScale===0||n>=s.maxScale;s.visible&&(y||u&&c)&&(s.sublayers?s.sublayers.forEach(i):e.unshift(s))};r&&r.forEach(i);const t=this._get("visibleSublayers");return!t||t.length!==e.length||t.some((s,n)=>e[n]!==s)?e:t}toJSON(){const e=this.layer;let r={dpi:e.dpi,format:e.imageFormat,transparent:e.imageTransparency,gdbVersion:e.gdbVersion||null};return this.hasDynamicLayers&&this.dynamicLayers?r.dynamicLayers=this.dynamicLayers:r={...r,layers:this.layers,layerDefs:this.layerDefs},r}};o([a({readOnly:!0})],m.prototype,"dynamicLayers",null),o([a()],m.prototype,"floors",void 0),o([a({readOnly:!0})],m.prototype,"hasDynamicLayers",null),o([a()],m.prototype,"layer",null),o([a({readOnly:!0})],m.prototype,"layers",null),o([a({readOnly:!0})],m.prototype,"layerDefs",null),o([a({type:Number})],m.prototype,"scale",void 0),o([a(K)],m.prototype,"timeExtent",void 0),o([a({readOnly:!0})],m.prototype,"version",null),o([a({readOnly:!0})],m.prototype,"visibleSublayers",null),m=o([$("esri.layers.mixins.ExportImageParameters")],m);let p=class extends G(ee(Y(A(z(B(W(Q(D(X(q(H(w(V))))))))))))){constructor(...e){super(...e),this.dateFieldsTimeReference=null,this.datesInUnknownTimezone=!1,this.dpi=96,this.gdbVersion=null,this.imageFormat="png24",this.imageMaxHeight=2048,this.imageMaxWidth=2048,this.imageTransparency=!0,this.isReference=null,this.labelsVisible=!1,this.operationalLayerType="ArcGISMapServiceLayer",this.preferredTimeReference=null,this.sourceJSON=null,this.sublayers=null,this.type="map-image",this.url=null}normalizeCtorArgs(e,r){return typeof e=="string"?{url:e,...r}:e}load(e){const r=L(e)?e.signal:null;return this.addResolvingPromise(this.loadFromPortal({supportedTypes:["Map Service"]},e).catch(F).then(()=>this._fetchService(r))),Promise.resolve(this)}readImageFormat(e,r){const i=r.supportedImageFormatTypes;return i&&i.includes("PNG32")?"png32":"png24"}writeSublayers(e,r,i,t){var d;if(!this.loaded||!e)return;const s=e.slice().reverse().flatten(({sublayers:l})=>l&&l.toArray().reverse()).toArray();let n=!1;if(this.capabilities&&this.capabilities.operations.supportsExportMap&&((d=this.capabilities.exportMap)!=null&&d.supportsDynamicLayers)){const l=v(t.origin);if(l===g.PORTAL_ITEM){const h=this.createSublayersForOrigin("service").sublayers;n=x(s,h,g.SERVICE)}else if(l>g.PORTAL_ITEM){const h=this.createSublayersForOrigin("portal-item");n=x(s,h.sublayers,v(h.origin))}}const y=[],u={writeSublayerStructure:n,...t};let c=n;s.forEach(l=>{const h=l.write({},u);y.push(h),c=c||l.originOf("visible")==="user"}),y.some(l=>Object.keys(l).length>1)&&(r.layers=y),c&&(r.visibleLayers=s.filter(l=>l.visible).map(l=>l.id))}createExportImageParameters(e,r,i,t){const s=t&&t.pixelRatio||1;e&&this.version>=10&&(e=e.clone().shiftCentralMeridian());const n=new m({layer:this,floors:t==null?void 0:t.floors,scale:U({extent:e,width:r})*s}),y=n.toJSON();n.destroy();const u=!t||!t.rotation||this.version<10.3?{}:{rotation:-t.rotation},c=e&&e.spatialReference,d=c.wkid||JSON.stringify(c.toJSON());y.dpi*=s;const l={};if(t!=null&&t.timeExtent){const{start:h,end:f}=t.timeExtent.toJSON();l.time=h&&f&&h===f?""+h:`${h??"null"},${f??"null"}`}else this.timeInfo&&!this.timeInfo.hasLiveData&&(l.time="null,null");return{bbox:e&&e.xmin+","+e.ymin+","+e.xmax+","+e.ymax,bboxSR:d,imageSR:d,size:r+","+i,...y,...u,...l}}async fetchImage(e,r,i,t){const{data:s}=await this._fetchImage("image",e,r,i,t);return s}async fetchImageBitmap(e,r,i,t){const{data:s,url:n}=await this._fetchImage("blob",e,r,i,t);return te(s,n)}async fetchRecomputedExtents(e={}){const r={...e,query:{returnUpdates:!0,f:"json",...this.customParameters,token:this.apiKey}},{data:i}=await b(this.url,r),{extent:t,fullExtent:s,timeExtent:n}=i,y=t||s;return{fullExtent:y&&R.fromJSON(y),timeExtent:n&&P.fromJSON({start:n[0],end:n[1]})}}loadAll(){return N(this,e=>{e(this.allSublayers)})}serviceSupportsSpatialReference(e){return se(this,e)}async _fetchImage(e,r,i,t,s){var u,c,d;const n={responseType:e,signal:(s==null?void 0:s.signal)??null,query:{...this.parsedUrl.query,...this.createExportImageParameters(r,i,t,s),f:"image",...this.refreshParameters,...this.customParameters,token:this.apiKey}},y=this.parsedUrl.path+"/export";if(((u=n.query)==null?void 0:u.dynamicLayers)!=null&&!((d=(c=this.capabilities)==null?void 0:c.exportMap)!=null&&d.supportsDynamicLayers))throw new S("mapimagelayer:dynamiclayer-not-supported",`service ${this.url} doesn't support dynamic layers, which is required to be able to change the sublayer's order, rendering, labeling or source.`,{query:n.query});try{const{data:l}=await b(y,n);return{data:l,url:y}}catch(l){throw M(l)?l:new S("mapimagelayer:image-fetch-error",`Unable to load image: ${y}`,{error:l})}}async _fetchService(e){if(this.sourceJSON)return void this.read(this.sourceJSON,{origin:"service",url:this.parsedUrl});const{data:r,ssl:i}=await b(this.parsedUrl.path,{query:{f:"json",...this.parsedUrl.query,...this.customParameters,token:this.apiKey},signal:e});i&&(this.url=this.url.replace(/^http:/i,"https:")),this.sourceJSON=r,this.read(r,{origin:"service",url:this.parsedUrl})}};o([a({type:I})],p.prototype,"dateFieldsTimeReference",void 0),o([a({type:Boolean})],p.prototype,"datesInUnknownTimezone",void 0),o([a()],p.prototype,"dpi",void 0),o([a()],p.prototype,"gdbVersion",void 0),o([a()],p.prototype,"imageFormat",void 0),o([j("imageFormat",["supportedImageFormatTypes"])],p.prototype,"readImageFormat",null),o([a({json:{origins:{service:{read:{source:"maxImageHeight"}}}}})],p.prototype,"imageMaxHeight",void 0),o([a({json:{origins:{service:{read:{source:"maxImageWidth"}}}}})],p.prototype,"imageMaxWidth",void 0),o([a()],p.prototype,"imageTransparency",void 0),o([a({type:Boolean,json:{read:!1,write:{enabled:!0,overridePolicy:()=>({enabled:!1})}}})],p.prototype,"isReference",void 0),o([a({json:{read:!1,write:!1}})],p.prototype,"labelsVisible",void 0),o([a({type:["ArcGISMapServiceLayer"]})],p.prototype,"operationalLayerType",void 0),o([a({json:{read:!1,write:!1}})],p.prototype,"popupEnabled",void 0),o([a({type:I})],p.prototype,"preferredTimeReference",void 0),o([a()],p.prototype,"sourceJSON",void 0),o([a({json:{write:{ignoreOrigin:!0}}})],p.prototype,"sublayers",void 0),o([J("sublayers",{layers:{type:[C]},visibleLayers:{type:[_]}})],p.prototype,"writeSublayers",null),o([a({type:["show","hide","hide-children"]})],p.prototype,"listMode",void 0),o([a({json:{read:!1},readOnly:!0,value:"map-image"})],p.prototype,"type",void 0),o([a(Z)],p.prototype,"url",void 0),p=o([$("esri.layers.MapImageLayer")],p);const oe=p,_e=Object.freeze(Object.defineProperty({__proto__:null,default:oe},Symbol.toStringTag,{value:"Module"}));export{_e as M,oe as _,m as c,O as n,Me as o};
