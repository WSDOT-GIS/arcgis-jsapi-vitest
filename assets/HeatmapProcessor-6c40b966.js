import{e as _,a as F}from"./Accessor-815cb0cf.js";import"./string-75082bc6.js";import{r as S,y as f}from"./typedArrayUtil-74bbfd45.js";import"./Error-781981d1.js";import"./ensureType-125d327f.js";import{m as U}from"./diffUtils-0b07ec68.js";import{s as v}from"./heatmapUtils-8c1efe72.js";import{o as E}from"./definitions-19bfb61c.js";import{p as O}from"./BaseProcessor-489bff05.js";import{o as a}from"./tileUtils-c2f19f52.js";import"./watch-c7facfb0.js";import"./ArrayPool-ae2ef0ab.js";import"./nextTick-3ee5a785.js";import"./promiseUtils-28f2a985.js";import"./Collection-912f4315.js";import"./Evented-3dfb26f2.js";import"./SimpleObservable-729c9019.js";import"./mathUtils-15f63a45.js";import"./screenUtils-7afeb41c.js";import"./vec4f64-aa64c7e9.js";import"./HandleOwner-124247b4.js";import"./reactiveUtils-31da19f9.js";class n{constructor(t,s){this.offset=t,this.extent=s}}function g(i){const t=i.key,s=new Map,r=256,e=E,o=i.tileInfoView.tileInfo.isWrappable;return s.set(a(t,-1,-1,o).id,new n([-e,-e],[e-r,e-r,e,e])),s.set(a(t,0,-1,o).id,new n([0,-e],[0,e-r,e,e])),s.set(a(t,1,-1,o).id,new n([e,-e],[0,e-r,r,e])),s.set(a(t,-1,0,o).id,new n([-e,0],[e-r,0,e,e])),s.set(a(t,1,0,o).id,new n([e,0],[0,0,r,e])),s.set(a(t,-1,1,o).id,new n([-e,e],[e-r,0,e,r])),s.set(a(t,0,1,o).id,new n([0,e],[0,0,e,r])),s.set(a(t,1,1,o).id,new n([e,e],[0,0,r,r])),s}let l=class extends O{constructor(){super(...arguments),this.type="heatmap",this._tileKeyToFeatureSets=new Map}initialize(){this.handles.add([this.tileStore.on("update",this.onTileUpdate.bind(this))])}async update(i,t){const s=t.schema.processors[0];s.type==="heatmap"&&U(this._schema,s)&&(i.mesh=!0,this._schema=s)}onTileUpdate(i){for(const t of i.removed)this._tileKeyToFeatureSets.delete(t.key.id)}onTileClear(i){const t={clear:!0};return this._tileKeyToFeatureSets.delete(i.key.id),this.remoteClient.invoke("tileRenderer.onTileData",{tileKey:i.id,data:t})}async onTileMessage(i,t,s){this._tileKeyToFeatureSets.has(i.key.id)||this._tileKeyToFeatureSets.set(i.key.id,new Map);const r=this._tileKeyToFeatureSets.get(i.key.id);if(r&&S(t.addOrUpdate)&&t.addOrUpdate.hasFeatures&&r.set(t.addOrUpdate.instance,t),t.end){const e=[],o=g(i);this._tileKeyToFeatureSets.forEach((c,d)=>{if(d===i.key.id)c.forEach(p=>f(p.addOrUpdate,m=>e.push(m)));else if(o.has(d)){const p=o.get(d),[m,T]=p.offset;c.forEach(w=>f(w.addOrUpdate,k=>{const K=k.transform(m,T,1,1);e.push(K)}))}});const h=v(e,this._schema.mesh,512,512),y={tileKey:i.key.id,intensityInfo:h},u=[h.matrix];return this.remoteClient.invoke("tileRenderer.onTileData",y,{...s,transferList:u})}}onTileError(i,t,s){return this.remoteClient.invoke("tileRenderer.onTileError",{tileKey:i.id,error:t},s)}};l=_([F("esri.views.2d.layers.features.processors.HeatmapProcessor")],l);const X=l;export{X as default};
